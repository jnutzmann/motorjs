<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <title>Motor simulator</title>
	<link rel="stylesheet" href="bootstrap.min.css">
	<link rel="stylesheet" href="bootstrap-theme.min.css">
	<script type="text/javascript" src="sylvester.js"></script>
	<script type="text/javascript" src="jquery-2.1.0.min.js"></script>
	<script type="text/javascript" src="three.min.js"></script>
	<script type="text/javascript" src="OrbitControls.js"></script>
  <script type="text/javascript" src="OBJLoader.js"></script>
  <script type="text/javascript" src="motor.js"></script>
  <script type="text/javascript" src="jquery.flot.min.js"></script>
  <script type="text/javascript" src="scope.js"></script>
  <script type="text/javascript" src="bootstrap.min.js"></script>
  <script type="text/javascript" src="wizard.js"></script>
  <script type="text/javascript">

	  
	  function vectorDraw(ctx, v) {
	    ctx.beginPath();
	    ctx.moveTo(0,0);
      ctx.lineTo(v.elements[0]*100,v.elements[1]*100);
      ctx.closePath();
      ctx.stroke();
	  }
	  function updateForms() {
      var form = document.forms['motor'];
      if (form.elements['loadtype'].value == 'speed') {
        $("#angVel-control").show();
        $("#loadtorque-control").hide();
      } else if (form.elements['loadtype'].value == 'torque') {
        $("#angVel-control").hide();
        $("#loadtorque-control").show();
      } else {
        $("#angVel-control").hide();
        $("#loadtorque-control").hide();
      }
      if (form.elements['drivetype'].value == 'voltage') {
        $("#vq-control").show();
        $("#iq-control").hide();
      } else {
        $("#vq-control").hide();
        $("#iq-control").show();
      }
	  }

	  	var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera( 75, 1, 0.1, 1000 );
		var rotor = new THREE.Object3D();
    var manager = new THREE.LoadingManager();
    var loader = new THREE.OBJLoader( manager );
    loader.load( 'obj/d1_ee_motor_rotor_may23.obj', function ( object ) {
      object.rotateOnAxis(new THREE.Vector3(0,-1,0), Math.PI/2);
      rotor.add( object );
    } );
		
		light = new THREE.DirectionalLight( 0xffffff );
		light.position.set( 1, 1, 1 );
		scene.add( light );
		light = new THREE.DirectionalLight( 0x555555 );
		light.position.set( -1, -1, -1 );
		scene.add( light );
		light = new THREE.AmbientLight( 0x222222 );
		scene.add( light );

		var renderer = new THREE.WebGLRenderer();
		renderer.setSize( 300,300 );
		renderer.setClearColor(0xFFFFFF, 1);
	  function init3D() {
		$("#silly-3d").append( renderer.domElement );
		var controls = new THREE.OrbitControls( camera, renderer.domElement );
		var form = document.forms['motor'];
		motor.params.polePairs = parseInt(form.elements['polePairs'].value);;
		
		var magnet_geometry = new THREE.CubeGeometry(1,1,1);
		var magnet_north_material = new THREE.MeshLambertMaterial( { color: 0xff0000 } );
		var magnet_south_material = new THREE.MeshLambertMaterial( { color: 0x0000FF } );
		for (var i = 0; i < motor.params.polePairs; i++) {
			var north = new THREE.Mesh( magnet_geometry, magnet_north_material );
			north.rotateOnAxis(new THREE.Vector3(0,0,1), (i/motor.params.polePairs)*2*Math.PI);
			north.translateX(4.5);
			rotor.add( north );
			var south = new THREE.Mesh( magnet_geometry, magnet_south_material );
			south.rotateOnAxis(new THREE.Vector3(0,0,1), (i/motor.params.polePairs+(0.5/motor.params.polePairs))*2*Math.PI);
			south.translateX(4.5);
			rotor.add( south );
		}
		scene.add(rotor);
		camera.position.z = 10;
	  }
    function updateMotor() {
      var form = document.forms['motor'];
      motor.params.polePairs = parseInt(form.elements['polePairs'].value);
      motor.params.kv = parseFloat(form.elements['kv'].value);
      motor.params.kt = motor.params.kv;
      motor.params.Rs = parseFloat(form.elements['rs'].value);
      motor.loadtorque = parseFloat(form.elements['loadtorque'].value);
      motor.iq = parseInt(form.elements['iq'].value);
      motor.vq = parseFloat(form.elements['vq'].value);
      motor.loadVel = parseFloat(form.elements['angVel'].value);
      motor.loadtype = form.elements['loadtype'].value;
      motor.drivetype = form.elements['drivetype'].value;
      motor.update(dt);

      var power = (motor.iq * motor.vq);
      var mechpower = motor.state.angVel * motor.loadtorque;
      
      d = $V([1,0]).rotate(motor.state.e_theta,center);
      q = $V([0,1]).rotate(motor.state.e_theta,center);
      a = a_ref.x(d.dot(a_ref));
      b = b_ref.x(d.dot(b_ref));
      c = c_ref.x(d.dot(c_ref));

      $("#rpm").html((motor.state.angVel * 9.5493).toFixed(2));
      $("#emf").html((motor.emf).toFixed(2));
      $("#torque").html((motor.motor_t).toFixed(2));
      $("#power").html(power.toFixed(2));
      $("#mechpower").html(mechpower.toFixed(2));
      if (motor.motor_t * motor.state.angVel > 0) {
        $("#efficiency").html(Math.abs(mechpower/power*100).toFixed(2));
      } else {
        $("#efficiency").html(Math.abs(power/mechpower*100).toFixed(2));
      }
      $("#vq").html(motor.vq.toFixed(2));
      $("#iq").html(motor.iq.toFixed(2));

      $("#resistanceloss").html((motor.iq*motor.iq*motor.params.Rs).toFixed(2));
      $("#bearingloss").html((motor.state.angVel*motor.params.drag*motor.state.angVel).toFixed(2));
      
      if (motor.motor_t * motor.state.angVel > 0) {
        $("#region").html("Motoring");
      } else {
        $("#region").html("Braking");
      }
      
      if (Math.abs(motor.state.angVel) > 200) {
        $("body").css("padding-left", Math.random()*Math.abs(motor.state.angVel)/100);
      }
    }
	  function draw3D() {
	    rotor.rotation = new THREE.Euler(0,0, motor.state.theta, 'XYZ');
	  	renderer.render(scene, camera);
    }
	  function init() {
	    window.requestAnimationFrame(draw);
      init3D();
    }
	  var lasttime = null;
    function draw(timestamp){
	    if (lasttime != null) {
        dt = (timestamp - lasttime)/1000;
        var slomo = parseFloat($("#slomo").val())
        if (isFinite(slomo)) {
          dt = dt / slomo;
        }
		  }
	    lasttime = timestamp;
		
      var canvas = document.getElementById('tutorial');
      updateMotor();
      updateForms();
      draw3D();
      if (canvas.getContext){
        var ctx = canvas.getContext('2d');
        ctx.save();
        ctx.clearRect(0,0,400,400);
        ctx.scale(2,-2);
        ctx.translate(100,-100);
        
        // coil vectors
        ctx.save();
        ctx.scale(0.25,0.25);
        var outerRadius = 300;
        for(var i = 0; i < motor.params.polePairs; i++) {
          ctx.translate(outerRadius,0);
          ctx.strokeStyle = "#7F7F7F";
          ctx.lineWidth = 1;
          vectorDraw(ctx, a_ref);
          vectorDraw(ctx, a_ref.x(-1));
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 4;
          vectorDraw(ctx, a);
          ctx.translate(-1*outerRadius,0);
          ctx.rotate(Math.PI*2/3 / motor.params.polePairs);
          ctx.translate(outerRadius,0);
          ctx.strokeStyle = "#7F7F7F";
          ctx.lineWidth = 1;
          vectorDraw(ctx, a_ref);
          vectorDraw(ctx, a_ref.x(-1));
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 4;
          vectorDraw(ctx, b.rotate(Math.PI*(-2/3),center));
          ctx.translate(-1*outerRadius,0);
          ctx.rotate(Math.PI*2/3 / motor.params.polePairs);
          ctx.translate(outerRadius,0);
          ctx.strokeStyle = "#7F7F7F";
          ctx.lineWidth = 1;
          vectorDraw(ctx, a_ref);
          vectorDraw(ctx, a_ref.x(-1));
          ctx.strokeStyle = "#000000";
          ctx.lineWidth = 4;
          vectorDraw(ctx, c.rotate(Math.PI*(-4/3),center));
          ctx.translate(-1*outerRadius,0);
          ctx.rotate(Math.PI*2/3 / motor.params.polePairs);
        }
        ctx.restore();
        ctx.rotate(motor.state.theta-Math.PI/2);
       
        
        // magnets
        ctx.beginPath();
        ctx.arc(0,0,25,0,Math.PI*2,true);
        ctx.stroke();
        ctx.closePath();
        for (var i = 0; i < motor.params.polePairs; i++) {
          ctx.fillStyle = "#FF0000";
          ctx.fillRect(-25 / motor.params.polePairs,25,50 / motor.params.polePairs,10);
          ctx.rotate(Math.PI / motor.params.polePairs);
          ctx.fillStyle = "#0000FF";
          ctx.fillRect(-25 / motor.params.polePairs,25,50 / motor.params.polePairs,10);
          ctx.rotate(Math.PI / motor.params.polePairs);
        }
        
        // magnet vector
        /*
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.lineTo(0,100);
        ctx.closePath();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.lineTo(100,0);
        ctx.stroke();
        */
        
        ctx.restore();
      }
      scope.draw();
		  window.requestAnimationFrame(draw);
    }
    </script>
    <style type="text/css">
      canvas { 
		/*border: 1px solid black;*/
		position: relative;
		width: 100%;
	  }
    </style>
  </head>
  <body onload="init();">
    <div class="container">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <span class="navbar-brand">MotorJS</span>
          <form class="navbar-form" role="form">
            <div class="form-group">
              <label>Slo-mo:</label>
              <input id="slomo" type="number" class="form-control" value="1"></input>
            </div>
          </form>
        </div>
      </nav>
      <div class="row">
        <div class="col-sm-10">
          <div id="scope-chart" style="clear:both; height: 200px;"></div>
        </div>
        <div class="col-sm-2">
          <div class="form-group">
            <label>X-axis</label>
            <select class="form-control"><option>Electrical theta</option></select>
          </div>
          <div class="form-group">
            <label>Y-axis</label>
            <select class="form-control" id="yaxis">
              <option value="motor_t">Motor torque</option>
              <option value="mag_field">Magnetic field (a)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row">
      <div class="col-sm-4"><canvas id="tutorial" width="400" height="400"></canvas></div>
      <div class="col-sm-4" id="silly-3d"></div>
      <div class="col-sm-4">
      <table class="table">
      <tr><td>Speed: </td><td id="rpm"></td><td>RPM</td></tr>
      <tr><td>EMF: </td><td id="emf"></td><td>V</td></tr>
      <tr><td>Voltage: </td><td id="vq"></td><td>V</td></tr>
      <tr><td>Current: </td><td id="iq"></td><td>A</td></tr>
      <tr><td>Torque: </td><td id="torque"></td><td>Nm</td></tr>
      <tr><td>Electrical Power: </td><td id="power"></td><td>W</td></tr>
      <tr><td>Mechanical Power: </td><td id="mechpower"></td><td>W</td></tr>
      <tr><td>Resistance loss: </td><td id="resistanceloss"></td><td>W</td></tr>
      <tr><td>Bearing loss: </td><td id="bearingloss"></td><td>W</td></tr>
      <tr><td>Efficiency: </td><td id="efficiency"></td><td>%</td></tr>
      <tr><td>Operation region: </td><td id="region"></td><td></td></tr>
      </table>
      </div>
      </div>
      <div class="row">
        <form id="motor" role="form">
          <div class="col-md-4">
            <h2>Motor settings:</h2>
            <div class="form-group">
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
              Motor wizard...
              </button>
            </div>
            <!--<button type="button" onclick="resetMotor()">Reset</button>-->
            <div class="form-group">
              <label for="polePairs">Pole pairs:</label><input class="form-control" type="number" id="polePairs" name="polePairs" min="1" max="10" step="1" value="6">
            </div>
            <div class="form-group">
              <label for="kv">Ke:</label><div class="input-group"><input class="form-control" type="number" id="kv" name="kv" min="1" max="10" step="0.01" value="1"><div class="input-group-addon">Vs/rad</div></div>
            </div>
            <div class="form-group">
              <label for="rs">Rs:</label><div class="input-group"><input class="form-control" type="number" id="rs" name="rs" min="1" max="10" step="0.01" value="0.1"><div class="input-group-addon">Ω</div></div>
            </div>
          </div>
          <div class="col-md-4">
            <h2>Load settings:</h2>
            <div class="form-group">
              <label>Load type:</label>
              <select name="loadtype" class="form-control">
                <option value="speed">Constant angular velocity</option>
                <option value="torque">Constant torque</option>
                <option value="car">Car load</option>
              </select>
            </div>
            <div class="form-group" id="angVel-control">
              <label for="angVel">Angular velocity:</label><input type="range" name="angVel" id="angVel" min="0" max="120" value="1" step="0.01">
            </div>
            <div class="form-group" id="loadtorque-control">
              <label>Load torque:</label><input type="range" name="loadtorque" min="-100" max="100" value="0">
            </div>
          </div>
          <div class="col-md-4">
            <h2>Inverter settings:</h2>
            <div class="form-group">
              <label>Drive type:</label>
              <select name="drivetype" class="form-control">
                <option value="current">Current</option>
                <option value="voltage">Voltage</option>
              </select>
            </div>
            <div class="form-group" id="iq-control">
              <label>Q-axis current:</label><input type="range" name="iq" min="-100" max="100" value="0">
            </div>
            <div class="form-group" id="vq-control">
              <label>Q-axis voltage:</label><input type="range" name="vq" min="-100" max="100" value="0">
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- motor input dialog -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Axial Flux Motor wizard</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Outer radius</label><input type="number" id="mw-or" class="form-control">
            </div>
            <div class="form-group">
              <label>Inner radius</label><input type="number" id="mw-ir" class="form-control">
            </div>
            <div class="form-group">
              <label>Mass</label>
              <div class="input-group">
                <div class="input-group-btn">
                  <button type="button" class="btn btn-default" onClick="updateMass()">Auto</button>
                </div>
                <input type="number" id="mw-mass" class="form-control">
                <div class="input-group-addon">
                  kg
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
		  </div>
		</div>
  </body>
</html>
